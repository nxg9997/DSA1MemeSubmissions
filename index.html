<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>DSA 1 Fall 2019 Meme Submissions</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vue"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="canvas-div">
        <canvas></canvas>
    </div>
    <div class="mdl-grid" id="app">
        <div class="mdl-grid mdl-cell mdl-cell--12-col mdl-cell--middle">
            <div class="mdl-cell mdl-cell--12-col mdl-cell--middle">
                <h1 class="center-text">DSA 1 Fall 2019 Meme Submissions</h1>
            </div>
            <div class="mdl-cell mdl-cell--12-col mdl-cell--middle">
                <p class="center-text">Here lies all the dank memes that were submitted as assignments during this semester. May the lemons be with you.</p>
            </div>
        </div>
        <div class="mdl-grid mdl-cell mdl-cell--12-col" id="simple-memes">
            <div class="mdl-cell mdl-cell--3-col" v-for="meme in memes">
                <img :src="meme.src"/>
            </div>
        </div>
    </div>
    <div id="mode">
        <select>
            <option value="simple">Simple</option>
            <option value="meme">Meme</option>
        </select>
    </div>
    <div style="display: none" id="riddle">
    </div>
</body>
<script src="./lib/victor.js"></script>
<script>
    //create the vue instance
    var app = new Vue({
        el: '#app',
        data: {
            test: "working :)",
            memes: []
        }
    });

    let modeSelect = document.querySelector('#mode').querySelector('select');
    let canvas = document.querySelector('canvas');
    let ctx = canvas.getContext('2d');

    let canvasData = {
        images: [],
        mousePos: [],
        mousePosIndex: 0,
        origin: new Victor(0,0),
        lemon: new Image(),
        lemonAlpha: 0
    };

    modeSelect.onchange = () => {
        if(modeSelect.value == 'meme'){
            document.body.style.fontFamily = "'Gochi Hand', cursive";
            document.querySelector('h1').style.fontFamily = "'Gochi Hand', cursive";
            document.querySelector('#simple-memes').style.display = 'none';
            document.querySelector("#canvas-div").style.display = 'inline';
            document.querySelector("#app").style.color = 'white';
            initCanvas();
        }
        else{
            document.body.style.fontFamily = '"Helvetica","Arial",sans-serif';
            document.querySelector('h1').style.fontFamily = '"Roboto","Helvetica","Arial",sans-serif';
            document.querySelector('#simple-memes').style.display = 'flex';
            document.querySelector("#canvas-div").style.display = 'none';
            document.querySelector("#app").style.color = 'black';
        }
    }

    //holds links to memes, not super useful anymore
    let memesList = [];

    //testing v-for
    /*app.memes.push({src:"https://cdn.shopify.com/s/files/1/2336/3219/products/shutterstock_77846398eureka2_x850.jpg"});
    app.memes.push({src:"https://cdn.shopify.com/s/files/1/2336/3219/products/shutterstock_77846398eureka2_x850.jpg"});
    app.memes.push({src:"https://cdn.shopify.com/s/files/1/2336/3219/products/shutterstock_77846398eureka2_x850.jpg"});
    app.memes.push({src:"https://cdn.shopify.com/s/files/1/2336/3219/products/shutterstock_77846398eureka2_x850.jpg"});
    */

    collectMemes();

    //fetches the json file containing all the locations of the memes. A server must be running for this to function.
    function collectMemes(){
        fetch('./memes.json',{method:"GET"}).then(data=>{
            data.json().then(final=>{
                console.log(final);
                for(let i = 0; i < final.memes.length; i++){
                    app.memes.push(final.memes[i]);
                }
            });
        });
    }

    function initCanvas(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let stuff = document.querySelectorAll('img');
        canvasData.images = [];
        console.log(app.memes);
        let total = 10;
        for(let i = 0; i < stuff.length; i++){
            //let img = new Image(100,100);
            //img.src = app.memes[i];
            canvasData.images.push(new Meme(stuff[i].src));
            canvasData.images[i].applyForce(new Victor(Math.random() * 10 - Math.random() * 20, Math.random() * 10 - Math.random() * 20));
        }
        for(let i = 0; i < canvasData.images.length; i++){
            if(Math.random() > .1){
                continue;
            }
            canvasData.images[i].canDraw = true;
            total--;
            if(total == 0) break;
        }

        for(let i = 0; i < 10; i++)
            canvasData.mousePos.push(new Victor(0,0));

        canvasData.lemon.src = "./lemon.png";
        canvasData.lemon.onload = () =>{
        
            document.querySelector('#riddle').innerHTML = '<iframe width="956" height="538" src="https://www.youtube.com/embed/kP45oOLCmHw?autoplay=1" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
            canvasLoop();
        }
    }

    onmousemove = e => {
        if(canvasData.mousePosIndex == 10){
            mousePosIndex = 0;
        }
        canvasData.mousePos[canvasData.mousePosIndex] = new Victor(e.clientX,e.clientY);
        canvasData.mousePosIndex++;
    }

    function deepFry(){
        ctx.restore();
        let cArr = ctx.getImageData(0,0,canvas.width,canvas.height);
        for(let i = 0; i < cArr.data.length; i+=4){
            /*let avg = [0,0,0];
            for(let j = i; j < i * 10; j+=4){
                avg[0] += cArr.data[j];
                avg[1] += cArr.data[j+1];
                avg[2] += cArr.data[j+2];
                
            }
            avg[0] /= 10;
            avg[1] /= 10;
            avg[2] /= 10;
            for(let j = i; j < i * 10; j+=4){
                cArr.data[j] = avg[0];
                cArr.data[j+1] = avg[1];
                cArr.data[j+1] = avg[2];
                //add more red
                cArr.data[j] += 100;
            }*/
            
            //add more red
            cArr.data[i] += 100;

            // v color shift v
            /*let r = Math.trunc(Math.random() * 255);
            let b = Math.trunc(Math.random() * 255);
            let g = Math.trunc(Math.random() * 255);
            cArr.data[i] += r;
            cArr.data[i+1] += g;
            cArr.data[i+2] += b;*/
        }
        ctx.putImageData(cArr,0,0);
        ctx.save();
        canvasData.origin.x += 10 - Math.random() * 20;
        canvasData.origin.y += 10 - Math.random() * 20;
        ctx.translate(canvasData.origin.x,canvasData.origin.y);
    }

    function canvasLoop(){
        requestAnimationFrame(canvasLoop);

        /*let avgMouseSpd = 0;
        for(let i = 1; i < canvasData.mousePos.length; i++){
            avgMouseSpd += canvasData.mousePos[i].clone().length - canvasData.mousePos[i-1].clone().length;
        }
        avgMouseSpd /= 10;
        console.log(avgMouseSpd);*/
        

        //ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = 'rgba(0,0,0,.1)';
        ctx.fillRect(0,0,canvas.width,canvas.height);

        ctx.save();
        ctx.globalAlpha = canvasData.lemonAlpha;
        ctx.drawImage(canvasData.lemon,0,0,canvas.width,canvas.height);
        canvasData.lemonAlpha += .001;
        ctx.restore();
        for(let i = 0; i < canvasData.images.length; i++){
            canvasData.images[i].update();
        }

        //ctx.filter = `invert(${100 - 100 / avgMouseSpd.length})`;
       // ctx.fillStyle = `rgba(255,0,0,${1 - 1/avgMouseSpd}`;
        ctx.save();
        //ctx.globalAlpha = 1/avgMouseSpd;
        ctx.fillStyle = 'red';
        //ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.restore();
        deepFry();
    }

    class Meme{
        constructor(src){
            this.src = src;
            this.img = new Image();
            this.img.src = src;
            this.img.onload = () =>{
                this.doneloading = true;
            }
            this.pos = new Victor(Math.random() * canvas.width, Math.random() * canvas.height);
            this.vel = new Victor(0,0);
            this.acc = new Victor(0,0);
            this.size = new Victor(.25,.25);
            this.alpha = Math.random();
            this.canDraw = false;
            this.doneloading = false;
            this.reverse = false;
        }

        draw(){
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.drawImage(this.img,this.pos.x,this.pos.y,this.size.x * this.img.width,this.size.y * this.img.height);
            ctx.restore();
        }

        applyForce(f){
            this.acc.add(f.clone());
        }

        setNextImage(){
            while(true){
                let rnum = Math.random() * canvasData.images.length;
                rnum = Math.trunc(rnum);
                if(!canvasData.images[rnum].canDraw){
                    canvasData.images[rnum].canDraw = true;
                    canvasData.images[rnum].pos = new Victor(Math.random() * canvas.width, Math.random() * canvas.height);
                    canvasData.images[rnum].applyForce(new Victor(Math.random() * 10 - Math.random() * 20, Math.random() * 10 - Math.random() * 20));
                    canvasData.images[rnum].size = new Victor(Math.random() * 2, Math.random() * 2);
                    break;
                    
                }
            }
        }

        update(){
            if(!this.canDraw || !this.doneloading){
                return;
            }
            this.draw();
            this.vel.add(this.acc.clone());
            this.pos.add(this.vel.clone());
            if(!this.reverse){
                this.alpha += 0.01;
            }
            else{
                this.alpha -= 0.01;
            }
            if(this.alpha > 1){
                this.reverse = true;
                this.alpha = 1;
            }
            else if (this.alpha < 0){
                this.reverse = false;
                this.alpha = 0;
                this.canDraw = false;
                this.setNextImage();
            }
            this.acc = new Victor(0,0);
        }
    }
</script>
</html>